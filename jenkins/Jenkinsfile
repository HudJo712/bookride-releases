pipeline {
    agent any

    options {
        timestamps()
    }

    environment {
        VENV = ".venv"
        DOCKER_IMAGE = "bookride-api:latest"
    }

    stages {
        stage('Checkout Book & Ride Code') {
            steps {
                // Uses the repository configured on the Jenkins job (adjust to explicit URL if needed)
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    set -e
                    python3 -m venv ${VENV}
                    . ${VENV}/bin/activate
                    pip install --upgrade pip build
                    pip install -e .[dev]
                '''
            }
        }

        stage('Run Book & Ride Tests') {
            steps {
                sh '''
                    set -e
                    . ${VENV}/bin/activate
                    mkdir -p reports
                    pytest -q --junitxml=reports/pytest-report.xml
                '''
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'reports/pytest-report.xml'
                }
            }
        }

        stage('Build Package (sdist + wheel)') {
            steps {
                sh '''
                    set -e
                    . ${VENV}/bin/activate
                    python -m build
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh '''
                    set -e
                    docker build -t ${DOCKER_IMAGE} -f api/Dockerfile .
                '''
            }
        }
    }

    post {
        success {
            echo 'Book & Ride CI pipeline completed successfully!'
        }
        failure {
            echo 'Book & Ride CI pipeline failed.'
        }
        cleanup {
            sh 'rm -rf ${VENV} build dist reports || true'
        }
    }
}
